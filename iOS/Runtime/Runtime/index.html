<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta name="referrer" content="never">
    <meta charset="utf-8">
    
    <title>知识库</title>
    
    
        <meta name="keywords" content="知识库">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="[TOC]  Runtime 脑图  概念Class、id、objc_object 定义源码 objc_class、objc_method 定义源码 category_t 定义源码 实例对象（objc_object）1typedef struct objc_object *id; id 是一个指向 objc_object 的指针 123456789struct objc_object &amp;#123;">
<meta property="og:type" content="article">
<meta property="og:title" content="知识库">
<meta property="og:url" content="http://yoursite.com/iOS/Runtime/Runtime/index.html">
<meta property="og:site_name" content="知识库">
<meta property="og:description" content="[TOC]  Runtime 脑图  概念Class、id、objc_object 定义源码 objc_class、objc_method 定义源码 category_t 定义源码 实例对象（objc_object）1typedef struct objc_object *id; id 是一个指向 objc_object 的指针 123456789struct objc_object &amp;#123;">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/4/1/1628088a3e4f0167">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/4/1/1628088a3e48a485">
<meta property="og:updated_time" content="2020-05-11T14:38:19.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="知识库">
<meta name="twitter:description" content="[TOC]  Runtime 脑图  概念Class、id、objc_object 定义源码 objc_class、objc_method 定义源码 category_t 定义源码 实例对象（objc_object）1typedef struct objc_object *id; id 是一个指向 objc_object 的指针 123456789struct objc_object &amp;#123;">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2018/4/1/1628088a3e4f0167">
    

    

    
        <link rel="icon" href="/wiki/favicon.ico">
    

    <link rel="stylesheet" href="/wiki/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/wiki/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/wiki/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/wiki/css/style.css">
    <script src="/wiki/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/wiki/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>
    
    
        <link rel="stylesheet" href="/wiki/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/wiki/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


    
</head>
</html>
<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/wiki/" id="logo">
                
                <span class="site-title">知识库</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/wiki/">首页</a>
                
            </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/wiki/',
        CONTENT_URL: '/wiki/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/wiki/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/wiki/">首页</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id='categories'>
        <h3 class="widget-title">
            <span>categories</span>
            &nbsp;
            <a id='allExpand' href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            C++
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/C++/C++多态/">
                                
                                    
                                    C++多态
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/C++/C++ 与 Objetive-C 的区别/">
                                
                                    
                                    C++ 与 Objetive-C 的区别
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/C++/C++头文件如何正确定义全局变量/">
                                
                                    
                                    C++头文件如何正确定义全局变量
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/C++/dynamic_cast/">
                                
                                    dynamic_cast
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/C++/C++默认参数/">
                                
                                    
                                    C++默认参数
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/C++/C++头文件的全局变量/">
                                
                                    
                                    C++头文件的全局变量
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/C++/unordered_map 与 map 的区别/">
                                
                                    
                                    unordered_map 与 map 的区别
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/C++/C++拾遗/">
                                
                                    
                                    C++拾遗
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/C++/static变量与static函数/">
                                
                                    
                                    static变量与static函数
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            iOS
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Block
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/iOS/Block/Block 的实现（简化版）/">
                                
                                    
                                    Block 的实现（简化版）
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/Block/Block_面试题/">
                                
                                    
                                    Block_面试题
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/Block/Block/">
                                
                                    
                                    Block
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            GCD
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/iOS/GCD/GCD/">
                                
                                    
                                    GCD
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/GCD/GCD_实践/">
                                
                                    
                                    GCD_实践
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/GCD/dispatch_set_target_queue/">
                                
                                    
                                    dispatch_set_target_queue
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            RunLoop
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/iOS/RunLoop/RunLoop 源码分析/">
                                
                                    
                                    RunLoop 源码分析
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/RunLoop/RunLoop/">
                                
                                    
                                    RunLoop
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            Runtime
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file active">
                            <a href="/wiki/iOS/Runtime/Runtime/">
                                
                                    
                                    Runtime
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/Runtime/Runtime_实践/">
                                
                                    
                                    Runtime_实践
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/Runtime/weak 的实现原理/">
                                
                                    
                                    weak 的实现原理
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/Runtime/关联对象的实现原理/">
                                
                                    
                                    关联对象的实现原理
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/Runtime/iOS 的 initialize 和 load 区别/">
                                
                                    
                                    iOS 的 initialize 和 load 区别
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/Runtime/分类/">
                                
                                    
                                    分类
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/Runtime/如何为协议添加属性/">
                                
                                    
                                    如何为协议添加属性
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/Runtime/如何为分类添加属性/">
                                
                                    
                                    如何为分类添加属性
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/Runtime/方法交换/">
                                
                                    
                                    方法交换
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            内存管理
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/iOS/内存管理/Weak-Strong Dance/">
                                
                                    
                                    Weak-Strong Dance
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/内存管理/autorelease/">
                                
                                    
                                    autorelease
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/内存管理/dealloc 探究/">
                                
                                    
                                    dealloc 探究
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            未分类
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/iOS/未分类/NSString 的坑/">
                                
                                    
                                    NSString 的坑
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/未分类/KVC/">
                                
                                    
                                    KVC
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/未分类/UIView 与 CALayer 区别/">
                                
                                    
                                    UIView 与 CALayer 区别
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/未分类/KVO/">
                                
                                    
                                    KVO
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/未分类/Native 与 JS 交互/">
                                
                                    
                                    Native 与 JS 交互
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/未分类/block 和 delegate 的区别/">
                                
                                    
                                    block 和 delegate 的区别
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/未分类/Property/">
                                
                                    
                                    Property
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/未分类/iOS 触摸机制/">
                                
                                    
                                    iOS 触摸机制
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/未分类/离屏渲染/">
                                
                                    
                                    离屏渲染
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/未分类/启动/">
                                
                                    
                                    启动
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/iOS/未分类/杂/">
                                
                                    
                                    杂
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            不务正业
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            BackEnd
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/不务正业/BackEnd/Ubuntu/">
                                
                                    
                                    Ubuntu
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Python
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/不务正业/Python/Python小知识/">
                                
                                    
                                    Python小知识
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/Python/Python参数/">
                                
                                    
                                    Python参数
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/Python/文件操作/">
                                
                                    
                                    文件操作
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            VideoNative
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/不务正业/VideoNative/VideoNative_加载VN页面_iOS篇/">
                                
                                    
                                    VideoNative_加载VN页面_iOS篇
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/VideoNative/CSS 解析原理/">
                                
                                    CSS 解析原理
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Xcode
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            库
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/不务正业/Xcode/库/库体积优化/">
                                
                                    库体积优化
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/Xcode/库/动态库和静态库/">
                                
                                    动态库和静态库
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                     
                        <li class="file">
                            <a href="/wiki/不务正业/Xcode/Cocoapods/">
                                
                                    Cocoapods
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/Xcode/新建工程移除StroyBoard/">
                                
                                    新建工程移除StroyBoard
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/Xcode/使用脚本添加Xcode文件/">
                                
                                    
                                    使用脚本添加Xcode文件
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            iOS 未分类
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/不务正业/iOS 未分类/iOS 图片加载的坑/">
                                
                                    
                                    iOS 图片加载的坑
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/iOS 未分类/iOS 沙盒目录结构/">
                                
                                    
                                    iOS 沙盒目录结构
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/iOS 未分类/弱引用集合对象/">
                                
                                    
                                    弱引用集合对象
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/iOS 未分类/iOS 状态栏/">
                                
                                    
                                    iOS 状态栏
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            前端
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/不务正业/前端/JavaScript/">
                                
                                    
                                    JavaScript
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/前端/JS 模块化/">
                                
                                    
                                    JS 模块化
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            小程序
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/不务正业/小程序/小程序踩坑/">
                                
                                    
                                    小程序踩坑
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            未分类
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/不务正业/未分类/《程序员修炼之道》小抄/">
                                
                                    
                                    《程序员修炼之道》小抄
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/未分类/查找日志技巧/">
                                
                                    查找日志技巧
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/未分类/知识碎片/">
                                
                                    知识碎片
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/不务正业/未分类/Hexo 特性/">
                                
                                    Hexo 特性
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            设计
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/不务正业/设计/设计零碎/">
                                
                                    
                                    设计零碎
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            算法
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            排序
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/算法/排序/基本排序/">
                                
                                    
                                    基本排序
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/算法/排序/快速排序/">
                                
                                    
                                    快速排序
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/算法/排序/堆排序/">
                                
                                    
                                    堆排序
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            搜索
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/算法/搜索/回溯算法/">
                                
                                    
                                    回溯算法
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            数据结构
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/算法/数据结构/链表/">
                                
                                    
                                    链表
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/算法/数据结构/动态规划/">
                                
                                    
                                    动态规划
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/算法/数据结构/树/">
                                
                                    
                                    树
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            网络
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/网络/HTTPS/">
                                
                                    
                                    HTTPS
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/网络/TCP 与 UDP/">
                                
                                    
                                    TCP 与 UDP
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/网络/TCP 三次握手/">
                                
                                    
                                    TCP 三次握手
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/网络/计算机网络基础/">
                                
                                    
                                    计算机网络基础
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/网络/TCP 四次挥手/">
                                
                                    
                                    TCP 四次挥手
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/网络/重放攻击/">
                                
                                    
                                    重放攻击
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            计算机基础
                        </a>
                         <ul class="unstyled" id="tree" >  
                        <li class="file">
                            <a href="/wiki/计算机基础/Git/">
                                
                                    Git
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/计算机基础/RESTful API/">
                                
                                    
                                    RESTful API
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/计算机基础/原码, 反码, 补码/">
                                
                                    
                                    原码, 反码, 补码
                                
                            </a>
                        </li>  
                        <li class="file">
                            <a href="/wiki/计算机基础/字符编码/">
                                
                                    
                                    字符编码
                                
                            </a>
                        </li>  </ul> 
                    </li> 
                     
                        <li class="file">
                            <a href="/wiki/index/">
                                
                                    工具书签
                                
                            </a>
                        </li>  </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main"><article id="post-iOS/Runtime/Runtime" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            
                <div class="article-meta">
                    
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/wiki/categories/iOS/">iOS</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/wiki/categories/iOS/Runtime/">Runtime</a>
    </div>

                    
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/iOS/Runtime/Runtime/">
            <time datetime="2020-08-15T09:01:57.818Z" itemprop="datePublished">2020-08-15</time>
        </a>
    </div>


                    
                    
                </div>
            
            
    <h1 itemprop="name">
        <a class="article-title" href="/wiki/iOS/Runtime/Runtime/">
            
            Runtime
        </a>
    </h1>

        </header>
        
        <div class="article-entry" itemprop="articleBody">
        
        
        
        
            <p>[TOC]</p>
<ul>
<li><a href="http://naotu.baidu.com/file/30a56f1e1bbb7af7f876353dda6f6b2c" target="_blank" rel="noopener">Runtime 脑图</a></li>
</ul>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p><a href="https://opensource.apple.com/source/objc4/objc4-750/runtime/objc.h.auto.html" target="_blank" rel="noopener">Class、id、<code>objc_object</code> 定义源码</a></p>
<p><a href="https://opensource.apple.com/source/objc4/objc4-750/runtime/runtime.h.auto.html" target="_blank" rel="noopener"><code>objc_class</code>、<code>objc_method</code> 定义源码</a></p>
<p><a href="https://opensource.apple.com/source/objc4/objc4-750/runtime/objc-runtime-new.h.auto.html" target="_blank" rel="noopener"><code>category_t</code> 定义源码</a></p>
<h2 id="实例对象（objc-object）"><a href="#实例对象（objc-object）" class="headerlink" title="实例对象（objc_object）"></a>实例对象（objc_object）</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</span><br></pre></td></tr></table></figure>
<p>id 是一个指向 <code>objc_object</code> 的指针</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    isa_t isa;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> isa_t </span><br><span class="line">&#123;</span><br><span class="line">	Class cls;</span><br><span class="line">	<span class="comment">// ... 省略其他</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单点说，<code>objc_object</code> 中包含了 Class 信息</p>
<h2 id="类对象（objc-class）"><a href="#类对象（objc-class）" class="headerlink" title="类对象（objc_class）"></a>类对象（objc_class）</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br></pre></td></tr></table></figure>
<p>Class 是一个指向 <code>objc_class</code> 的指针</p>
<p>在 Objc2.0 之前，<code>objc_class</code> 源码如下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_class</span><br><span class="line">&#123;</span><br><span class="line">	Class isa OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !__OBJC2__</span></span><br><span class="line">	Class super_class 	OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name 	OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">long</span> version 		OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">long</span> info 			OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">long</span> instance_size 	OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">struct</span> objc_ivar_list *ivars 			OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">struct</span> objc_method_list **methodLists 	OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">struct</span> objc_cache *cache 				OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">struct</span> objc_protocol_list *protocols 	OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure>
<p>然后在 2006 年苹果发布 Objc2.0 之后，<code>objc_class</code> 的定义就变成下面这个样子了</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_class : objc_object &#123;</span><br><span class="line">    Class superclass;</span><br><span class="line">    cache_t cache;             </span><br><span class="line">    class_data_bits_t bits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 Objc2.0 中，所有的对象都会包含一个<code>isa_t</code> 类型的 isa 指针</p>
<p><code>objc_class</code> 继承于 <code>objc_object</code>，所以 <code>objc_class</code> 也包含了 isa 指针，故类本身其实也是一个对象，称之为类对象</p>
<p>这意味着，可以像向实例对象发送消息一样，我们可以向类对象发送消息，比如 <code>[Person alloc]</code></p>
<p><code>class_data_bits_t</code> 存储着类对象的相关数据（比如对象方法、对象成员等等），Objc2.0 之前存储在 <code>objc_class</code> 的信息都放到这里了</p>
<p>当一个对象的实例方法被调用的时候，会通过 isa 找到相应的类，然后在该类的<code>class_data_bits_t</code> 中去查找方法实现</p>
<p>但是在我们调用类方法的时候，类对象的 isa 里面是什么呢？这里为了和对象查找方法的机制一致，遂引入了元类的概念</p>
<h2 id="元类"><a href="#元类" class="headerlink" title="元类"></a>元类</h2><p><img src="https://user-gold-cdn.xitu.io/2018/4/1/1628088a3e4f0167" alt></p>
<!--![](http://yulingtianxia.com/resources/Runtime/class-diagram.jpg)-->
<p>上图可以看出：</p>
<ol>
<li><p>Superclass</p>
<ul>
<li>实例对象之间没有父子关系，有父子关系的是类对象和元类</li>
<li>NSObject 类的父类是 nil</li>
<li>特殊：NSObject 元类的父类是 NSObject 类对象</li>
</ul>
</li>
<li><p>isa</p>
<p> 可以理解“是一个”</p>
<ul>
<li>实例对象“是一个”类对象，类对象“是一个”元类</li>
<li>特殊：任何元类都“是一个” NSObject 元类</li>
</ul>
</li>
</ol>
<ul>
<li>【消息发送】：当一个消息发送给任何一个对象时，将会由对象的 isa 指针开始查找方法，接着沿着 superclass 链向上去查找</li>
<li>【内存布局】：不同实例对象对应的类，父类，元类打印出来的地址相同，因为 main 方法执行之前，类对象和元类对象就被创建</li>
</ul>
<h3 id="理解好对象、类和元类的关系（为什么需要元类）"><a href="#理解好对象、类和元类的关系（为什么需要元类）" class="headerlink" title="理解好对象、类和元类的关系（为什么需要元类）"></a>理解好对象、类和元类的关系（为什么需要元类）</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person *p = [[Person alloc] init];</span><br></pre></td></tr></table></figure>
<p>其中，p 是对象，Person 是类。注意，<strong>类本身也是对象</strong>，所以我们可以把类叫做类对象</p>
<p>对象的实例方法存放在类对象中，对象是以类对象为模版进行创建</p>
<p>而<strong>类对象与元类的关系好比对象和类对象的关系</strong>，元类中保存了创建类对象以及类方法所需的所有信息</p>
<ul>
<li>当你给对象发送消息时，消息是从这个对象的类的方法列表中查找</li>
<li>当你给类发消息时，消息是从这个类的元类的方法列表中查找</li>
</ul>
<p>到此，我们可以理解，为什么类对象“是一个”元类；也可以理解为什么需要元类这个概念（为了和对象查找方法的机制一致）</p>
<p>类对象和元类对象是唯一的，对象是可以在运行时创建无数个的。而在 main 方法执行之前，类对象和元类对象被创建</p>
<h3 id="引申思考：究竟什么样的数据结构才算对象？"><a href="#引申思考：究竟什么样的数据结构才算对象？" class="headerlink" title="引申思考：究竟什么样的数据结构才算对象？"></a>引申思考：究竟什么样的数据结构才算对象？</h3><p>每个对象都有一个类，这个是 Objective-C 中关于面向对象的内容</p>
<p>实际上，任何数据结构，只要其内存区域的第一块位置是以指向 Class 的指针都可以被称之为对象</p>
<p>比如 <code>objc_object</code>，Objc2.0 前的 <code>objc_class</code>， Objc2.0 后的 <code>objc_class</code> </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// isa_t 展开之后</span></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    Class isa;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Objc2.0 前</span></span><br><span class="line"><span class="keyword">struct</span> objc_class</span><br><span class="line">&#123;</span><br><span class="line">	Class isa;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Objc2.0 后，继承关系展开之后</span></span><br><span class="line"><span class="keyword">struct</span> objc_class : objc_object &#123;</span><br><span class="line">    Class isa;</span><br><span class="line">    Class superclass;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="引申思考：类对象是一个对象，那么元类是对象吗？"><a href="#引申思考：类对象是一个对象，那么元类是对象吗？" class="headerlink" title="引申思考：类对象是一个对象，那么元类是对象吗？"></a>引申思考：类对象是一个对象，那么元类是对象吗？</h3><p>类对象是 <code>objc_class</code>，它的 isa 指针指向的是一个 <code>objc_class</code>，这就意味着元类是一个 <code>objc_class</code> 描述的结构。由于 <code>objc_class</code> 的第一个位置存放着 Class 指针，所以元类本身也是一个对象！所有的元类的 Class 指针指向的都是根元类</p>
<p>即所有元类的类都是根元类，这个是规则。由于这条规则，根元类（即 NSObject 类的元类）的 isa 指针指向了自己，也就是说根元类是它自己的一个实例</p>
<h3 id="引申思考：objc-object-对应对象，objc-class-对应类对象，那是不是会有-objc-meta-class-对应元类"><a href="#引申思考：objc-object-对应对象，objc-class-对应类对象，那是不是会有-objc-meta-class-对应元类" class="headerlink" title="引申思考：objc_object 对应对象，objc_class 对应类对象，那是不是会有 objc_meta_class 对应元类"></a>引申思考：<code>objc_object</code> 对应对象，<code>objc_class</code> 对应类对象，那是不是会有 <code>objc_meta_class</code> 对应元类</h3><p>id 是一个指向 <code>objc_object</code> 的指针，Class 是一个指向 <code>objc_class</code> 的指针，由此看，id 对应对象，Class 对应类对象确实没错，id 和 Class 都是开发者层面能接触到的，但是元类开发者并不会接触到，所以没有一个对应的“开发层面的概念”对应元类。</p>
<p>元类本身也是一个对象，是用 <code>objc_class</code> 来描述。</p>
<p>即对象用 <code>objc_object</code> 描述；类对象和元类都是用 <code>objc_class</code> 描述</p>
<h3 id="引申思考：为什么所有元类的-isa-指针直接指向了根元类？"><a href="#引申思考：为什么所有元类的-isa-指针直接指向了根元类？" class="headerlink" title="引申思考：为什么所有元类的 isa 指针直接指向了根元类？"></a>引申思考：为什么所有元类的 isa 指针直接指向了根元类？</h3><p>这是规定（我猜：指向 nil 或其他地方都没有指向根元类合理），同时元类的 isa 指针不是很重要，因为在现实世界中没人向元类发送消息</p>
<h3 id="引申思考：为什么-NSObject-元类的父类是-NSObject-类对象？"><a href="#引申思考：为什么-NSObject-元类的父类是-NSObject-类对象？" class="headerlink" title="引申思考：为什么 NSObject 元类的父类是 NSObject 类对象？"></a>引申思考：为什么 NSObject 元类的父类是 NSObject 类对象？</h3><p>因为 NSObject 定义了一系列“抽象方法”，这里面既有实例方法，又有类方法</p>
<ul>
<li><ul>
<li>class</li>
</ul>
</li>
<li><ul>
<li>class</li>
</ul>
</li>
<li><ul>
<li>isMemberOfClass</li>
</ul>
</li>
<li><ul>
<li>isKindOfClass</li>
</ul>
</li>
<li><ul>
<li>respondsToSelector</li>
</ul>
</li>
<li><ul>
<li>conformsToProtocol</li>
</ul>
</li>
<li><ul>
<li>conformsToProtocol</li>
</ul>
</li>
<li><ul>
<li>methodForSelector</li>
</ul>
</li>
<li><ul>
<li>instanceMethodForSelector</li>
</ul>
</li>
</ul>
<p>注意：这些方法中的类方法列表是存放在 NSObject 根元类的数据结构中，但是这些方法是“写”在 NSObject.m 中</p>
<p>定义 NSObject 元类的父类为 NSObject 类对象，导致了所有的实例对象、类对象和元类对象都是 NSObject 类对象的实例（除了 NSObject 类对象自己）</p>
<blockquote>
<p>NSObject 类对象是万物之根</p>
</blockquote>
<p>意义在于，元类对象也能调用 NSObject 的实例方法?</p>
<p>如果一个类的类方法没有被实现，最终会去 NSObject 的实例方法中寻找</p>
<ul>
<li>对于所有的实例对象，都能够调用到 NSObject 的实例方法</li>
<li>对于所有的类对象和元类对象，都能够调用到 NSObject 的类方法</li>
</ul>
<blockquote>
<p>For all instances, classes and meta-classes in the NSObject hierarchy, this means that all NSObject instance methods are valid. For the classes and meta-classes, all NSObject class methods are also valid. ——引自<a href="http://www.cocoawithlove.com/2010/01/what-is-meta-class-in-objective-c.html" target="_blank" rel="noopener">《What is a meta-class in Objective-C?》</a></p>
</blockquote>
<h2 id="Method（objc-method）"><a href="#Method（objc-method）" class="headerlink" title="Method（objc_method）"></a>Method（objc_method）</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_method &#123;</span><br><span class="line">    SEL method_name;		<span class="comment">// 方法名（区分方法的标识）</span></span><br><span class="line">    <span class="keyword">char</span> *method_types;		<span class="comment">// 返回值类型</span></span><br><span class="line">    IMP method_imp;			<span class="comment">// 方法实现</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SEL 与 IMP 的关系类似于 key 与 value 的关系</p>
<h2 id="SEL（objc-selector）"><a href="#SEL（objc-selector）" class="headerlink" title="SEL（objc_selector）"></a>SEL（objc_selector）</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_selector *SEL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_selector &#123;</span><br><span class="line">    <span class="keyword">char</span> *name;			<span class="comment">// 方法名称</span></span><br><span class="line">    <span class="keyword">char</span> *types;		<span class="comment">// 返回值类型</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>SEL 是一个指向 <code>objc_selector</code> 的指针，可以理解为方法（Method）的 ID</p>
<p>IMP 可以理解为函数指针，指向了最终的实现</p>
<h3 id="引申思考：关于重载"><a href="#引申思考：关于重载" class="headerlink" title="引申思考：关于重载"></a>引申思考：关于重载</h3><p>Objective-C 中不支持函数重载就是因为 SEL 只记录了方法名而没有参数，同时一个类的方法列表中不能存在两个相同的 SEL </p>
<h3 id="引申思考：关于重写"><a href="#引申思考：关于重写" class="headerlink" title="引申思考：关于重写"></a>引申思考：关于重写</h3><p>不同的类可以有同一个 SEL，这些 SEL 对应着不同的实现</p>
<p>不同类的实例对象执行相同的 SEL 时，会在各自的方法列表中去根据 SEL 去寻找自己对应的 IMP</p>
<p>这使得 OC 可以支持函数重写</p>
<p>比如父类和子类都有 viewDidLoad，父类和子类是两个不同的类对象，同时有相同的 SEL，即 viewDidLoad，而其 IMP 又不一样</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> SEL selector;</span><br></pre></td></tr></table></figure>
<p>Objective-C 中的 selector 是 SEL 的一个实例对象</p>
<p>我们可以用 <code>@selector()</code> 返回的是一个 SEL 类型的方法选择器</p>
<h2 id="方法实现（IMP）"><a href="#方法实现（IMP）" class="headerlink" title="方法实现（IMP）"></a>方法实现（IMP）</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">id</span> (*IMP)(<span class="keyword">id</span>, SEL, ...);</span><br></pre></td></tr></table></figure>
<p><strong>关于函数指针</strong></p>
<p>先了解函数指针的概念</p>
<blockquote>
<p>typedef 返回类型(<code>*</code>函数指针名)(参数表)</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*funPointer)</span><span class="params">(<span class="keyword">int</span>)</span></span>; </span><br><span class="line">funPointer pFun;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myFun</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;print(<span class="string">"Hello"</span>);&#125; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    pFun = myFun; </span><br><span class="line">    (*pFun)(<span class="number">2</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以 IMP 是一个函数指针，指向类似 <code>id FunName(id, SEL, ...){...}</code> 的函数实现</p>
<p>在 Runtime 中，IMP 指向着方法最终实现的内存地址</p>
<h2 id="类缓存（objc-cache）"><a href="#类缓存（objc-cache）" class="headerlink" title="类缓存（objc_cache）"></a>类缓存（objc_cache）</h2><p>Runtime 中，每当找到一个类的方法时，会放入它的缓存，即 <code>objc_class</code> 中的 <code>objc_cache</code>，以加快下次方法调用时的查找效率</p>
<h2 id="分类（objc-category）"><a href="#分类（objc-category）" class="headerlink" title="分类（objc_category）"></a>分类（objc_category）</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> category_t &#123; </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name; 							<span class="comment">// 原类名，而不是分类名</span></span><br><span class="line">    <span class="comment">// 要扩展的类对象，编译期间是不会定义的，而是在 Runtime 阶段通过 name 对应到对应的类对象</span></span><br><span class="line">    classref_t cls; 							</span><br><span class="line">    <span class="keyword">struct</span> method_list_t *instanceMethods; 		<span class="comment">// 分类中新增的对象方法列表</span></span><br><span class="line">    <span class="keyword">struct</span> method_list_t *classMethods;			<span class="comment">// 分类中新增的类方法列表</span></span><br><span class="line">    <span class="keyword">struct</span> protocol_list_t *protocols;			<span class="comment">// 分类中新增的协议列表</span></span><br><span class="line">    <span class="keyword">struct</span> property_list_t *instanceProperties;	<span class="comment">// 分类中新增的属性列表</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="引申思考：如何在分类中添加属性"><a href="#引申思考：如何在分类中添加属性" class="headerlink" title="引申思考：如何在分类中添加属性"></a>引申思考：<a href="../如何为分类添加属性">如何在分类中添加属性</a></h3><p>可以看出，分类中可以添加实例方法，类方法，甚至可以实现协议，添加属性，但不可以添加成员变量</p>
<p>instanceProperties 的存在是我们可以通过 <code>objc_setAssociatedObject</code> 和 <code>objc_getAssociatedObject</code> 向分类中增加实例变量的原因，不过这个和一般的实例变量是不一样的</p>
<h1 id="消息发送（objc-msgSend）"><a href="#消息发送（objc-msgSend）" class="headerlink" title="消息发送（objc_msgSend）"></a>消息发送（<code>objc_msgSend</code>）</h1><p>一个对象的方法像这样[obj foo]，编译器转成 <code>objc_msgSend(obj, foo)</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> objc_msgSend(<span class="keyword">id</span> <span class="keyword">self</span>, SEL op, ...)</span><br></pre></td></tr></table></figure>
<p>Runtime 时执行的流程是这样的：</p>
<ol>
<li>通过 obj 的 isa 指针找到它的类对象（obj 是一个 id，即 <code>objc_object</code> 指针，有 isa 指针）</li>
<li>在类对象的方法列表中寻找 foo（<code>objc_class</code> 的 methodLists）</li>
<li>如果类对象中没到 foo，继续往它的 superclass 中找</li>
<li>一旦找到 foo 这个函数（<code>objc_method</code>），就去执行它的实现 IMP，并转发 IMP 的返回值    </li>
</ol>
<p>如果每次消息传递都沿着继承链，在每个类的 methodLists 查找方法其实效率很低，所以需要缓存，即 <code>objc_class</code> 中的 <code>objc_cache</code>，key 是 <code>objc_method</code> 中的SEL，value 是 <code>objc_method</code> 中的IMP</p>
<h1 id="消息转发（-objc-msgforward）"><a href="#消息转发（-objc-msgforward）" class="headerlink" title="消息转发（_objc_msgforward）"></a>消息转发（<code>_objc_msgforward</code>）</h1><p>如果消息传递的过程中，沿着继承树查找到最终的根类（NSObject）还是没有对应的方法实现，则会进行消息转发，如果消息转发失败了就回执行 <code>doesNotRecognizeSelector:</code> 方法报<code>unrecognized selector</code> 错</p>
<p>什么是消息转发呢，主要分为以下三个阶段</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/4/1/1628088a3e48a485" alt></p>
<h2 id="动态方法解析"><a href="#动态方法解析" class="headerlink" title="动态方法解析"></a>动态方法解析</h2><p>第一个阶段 Runtime 会调用 <code>+resolveInstanceMethod:</code> 或者 <code>+resolveClassMethod:</code>（取决于是实例方法还是类方法），让你有机会提供一个函数实现。如果你添加了函数并返回YES， 那运行时系统就会重新启动一次消息发送的过程</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad </span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(foo:)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel </span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(foo:)) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 注意参数 fooMethod 这里是作为一个函数指针传递</span></span><br><span class="line">		class_addMethod([<span class="keyword">self</span> <span class="keyword">class</span>], sel, (IMP)fooMethod, <span class="string">"v@:"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> fooMethod(<span class="keyword">id</span> obj, SEL _cmd) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Hello"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="快速转发（替换消息接收者）"><a href="#快速转发（替换消息接收者）" class="headerlink" title="快速转发（替换消息接收者）"></a>快速转发（替换消息接收者）</h2><p>如果你错过了第一阶段，则进入第二阶段。Runtime 会调用 forwardingTargetForSelector 给你把这个消息转发给其他对象的机会</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector </span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(foo)) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> [Person new];</span><br><span class="line">	&#125;</span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">return</span> [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="完整消息转发"><a href="#完整消息转发" class="headerlink" title="完整消息转发"></a>完整消息转发</h2><p>最后一步会发送 <code>-methodSignatureForSelector:</code> 消息获得函数的参数和返回值类型。</p>
<ul>
<li>如果返回nil ，Runtime 则会发出 <code>-doesNotRecognizeSelector:</code> 消息，程序这时也就挂掉了</li>
<li>如果返回了一个函数签名，Runtime 就会创建一个 NSInvocation 对象并发送 <code>-forwardInvocation:</code> 消息给目标对象</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector </span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> ([<span class="built_in">NSStringFromSelector</span>(aSelector) isEqualToString:<span class="string">@"foo"</span>]) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 返回签名，进入 forwardInvocation</span></span><br><span class="line">		<span class="keyword">return</span> [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:<span class="string">"v@:"</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> [<span class="keyword">super</span> methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation </span><br><span class="line">&#123;</span><br><span class="line">	SEL sel = anInvocation.selector;</span><br><span class="line">	</span><br><span class="line">	Person *p = [Person new];</span><br><span class="line">	<span class="keyword">if</span> ([p respondsToSelector:sel]) </span><br><span class="line">	&#123;</span><br><span class="line">		[anInvocation invokeWithTarget:p];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">	&#123;</span><br><span class="line">		[<span class="keyword">self</span> doesNotRecognizeSelector:sel];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>什么是 <code>&quot;v@:&quot;</code>，详细可参见<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html#//apple_ref/doc/uid/TP40008048-CH100-SW1" target="_blank" rel="noopener">Type Encodings</a></p>
<p>所以不同与第二阶段，在这个阶段你可以：</p>
<ul>
<li>把消息存储，在你觉得合适的时机转发出去，或者不处理这个消息。</li>
<li>修改消息的 target，selector，参数等</li>
<li>多次转发这个消息，转发给多个对象</li>
</ul>
<p>显然在这个阶段，你可以对消息做更多的事情，是第二个阶段的扩充</p>
<h2 id="引申思考：消息转发为什么要三个阶段呢？"><a href="#引申思考：消息转发为什么要三个阶段呢？" class="headerlink" title="引申思考：消息转发为什么要三个阶段呢？"></a>引申思考：消息转发为什么要三个阶段呢？</h2><p>第一阶段意义在于动态添加方法实现，第二阶段直接把消息转发给其他对象，第三阶段是对第二阶段的扩充，可以实现多次转发，转发给多个对象等</p>
<p>如果只是考虑消息转发的功能，那么只提供最后一个阶段就可以实现，所以这个问题的本质是，为什么要多提供前面两个阶段？</p>
<p>Objective-C 的消息机制与 C++ 等静态编译语言不同，提供动态性的同时必然也牺牲了调用的效率。消息转发的效率必然不如 C++ 的函数调用。</p>
<p>从效率上讲，完整的消息转发效率太低，提供前面两个阶段就是为了让消息能够尽快得到处理；因为三个阶段步骤越往后，处理消息累计开销就越大。</p>
<p><a href="http://www.cocoachina.com/articles/13336" target="_blank" rel="noopener">《Objective-C 与 Runtime：为什么是这样？》（R.I.P）</a></p>
<h1 id="Runtime-应用"><a href="#Runtime-应用" class="headerlink" title="Runtime 应用"></a>Runtime 应用</h1><h2 id="Swizzle-Method"><a href="#Swizzle-Method" class="headerlink" title="Swizzle Method"></a><a href="../%E6%96%B9%E6%B3%95%E4%BA%A4%E6%8D%A2/">Swizzle Method</a></h2><h2 id="自定义-KVO-实现"><a href="#自定义-KVO-实现" class="headerlink" title="自定义 KVO 实现"></a><a href="http://liuduo.me/2018/02/07/kvo-imp/" target="_blank" rel="noopener">自定义 KVO 实现</a></h2><h2 id="给分类添加属性"><a href="#给分类添加属性" class="headerlink" title="给分类添加属性"></a><a href="../%E5%A6%82%E4%BD%95%E4%B8%BA%E5%88%86%E7%B1%BB%E6%B7%BB%E5%8A%A0%E5%B1%9E%E6%80%A7/">给分类添加属性</a></h2><h2 id="打印类的所有属性值"><a href="#打印类的所有属性值" class="headerlink" title="打印类的所有属性值"></a>打印类的所有属性值</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)description</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>, [<span class="keyword">self</span> properties_values]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)properties_values</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *props = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount, i;</span><br><span class="line">    objc_property_t *properties = class_copyPropertyList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; outCount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        objc_property_t property = properties[i];</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *char_f = property_getName(property);</span><br><span class="line">        <span class="built_in">NSString</span> *propertyName = [<span class="built_in">NSString</span> stringWithUTF8String:char_f];</span><br><span class="line">        <span class="keyword">id</span> propertyValue = [<span class="keyword">self</span> valueForKey:propertyName];</span><br><span class="line">        <span class="keyword">if</span> (propertyValue)</span><br><span class="line">        &#123;</span><br><span class="line">            [props setObject:propertyValue forKey:propertyName];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free(properties);</span><br><span class="line">    <span class="keyword">return</span> props;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以将 <code>properties_values</code> 方法，写到 NSObject 的分类里，就不需要每个人都写一份</p>
<h2 id="实现-NSCoding-的自动归档和自动解档"><a href="#实现-NSCoding-的自动归档和自动解档" class="headerlink" title="实现 NSCoding 的自动归档和自动解档"></a>实现 NSCoding 的自动归档和自动解档</h2><p>OC 中归档解档又称为序列化和反序列化</p>
<p>归档/解档需要实现 NSCoding 协议方法，在 NSCoding 协议方法中实现了对每个属性分别进行归档/解档，归档对属性值归档为相应的字段，解档依据相应的字段为对象属性赋值</p>
<p>可以使用 Runtime 的 <code>Ivar *class_copyIvarList</code> 方法获取某个类的属性个数和属性列表。遍历属性列表，可获取每个属性的名字，然后使用 <strong>KVC</strong> 获取或设置每个属性的值</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)coder</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> code:<span class="literal">YES</span> coder:coder];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)coder</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) </span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="keyword">self</span> code:<span class="literal">NO</span> coder:coder];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)code:(<span class="built_in">BOOL</span>)isEncode coder:(<span class="built_in">NSCoder</span> *)coder</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">    Ivar *ivars = class_copyIvarList([UserModel <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i++) </span><br><span class="line">    &#123;</span><br><span class="line">        Ivar ivar = ivars[i];</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> * name = ivar_getName(ivar);</span><br><span class="line">        <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line">        <span class="keyword">id</span> value;</span><br><span class="line">        <span class="keyword">if</span> (isEncode) </span><br><span class="line">        &#123;</span><br><span class="line">            value = [<span class="keyword">self</span> valueForKey:key];</span><br><span class="line">            [coder encodeObject:value forKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            value = [coder decodeObjectForKey:key];</span><br><span class="line">            [<span class="keyword">self</span> setValue:value forKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free(ivars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现字典和模型的自动转换（MJExtension）"><a href="#实现字典和模型的自动转换（MJExtension）" class="headerlink" title="实现字典和模型的自动转换（MJExtension）"></a>实现字典和模型的自动转换（MJExtension）</h2><p>用 Runtime 提供的函数遍历 Model 自身所有属性，如果属性在 json 中有对应的值，则将其赋值</p>
<p>核心方法：在 NSObject 的分类中添加方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithDict:(<span class="built_in">NSDictionary</span> *)dict </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">self</span> init]) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *keys = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *attributes = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount;</span><br><span class="line">        objc_property_t *properties = class_copyPropertyList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) </span><br><span class="line">        &#123;</span><br><span class="line">            objc_property_t property = properties[i];</span><br><span class="line">            <span class="built_in">NSString</span> * propertyName = [<span class="built_in">NSString</span> stringWithCString:property_getName(property) encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">            [keys addObject:propertyName];</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">NSString</span> * propertyAttribute = [<span class="built_in">NSString</span> stringWithCString:property_getAttributes(property) encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">            [attributes addObject:propertyAttribute];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        free(properties);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> * key <span class="keyword">in</span> keys) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ([dict valueForKey:key] == <span class="literal">nil</span>) <span class="keyword">continue</span>;</span><br><span class="line">            [<span class="keyword">self</span> setValue:[dict valueForKey:key] forKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="热更新（JSPatch）"><a href="#热更新（JSPatch）" class="headerlink" title="热更新（JSPatch）"></a>热更新（JSPatch）</h2><p>JS 传递字符串给 OC，OC 通过 Runtime 接口调用和替换 OC 方法</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ul>
<li><a href="https://juejin.im/post/5ac0a6116fb9a028de44d717#heading-1" target="_blank" rel="noopener">iOS Runtime详解</a></li>
<li><a href="https://halfrost.com/objc_runtime_isa_class/" target="_blank" rel="noopener">神经病院 Objective-C Runtime 入院第一天—— isa 和 Class</a></li>
<li><a href="http://www.cocoawithlove.com/2010/01/what-is-meta-class-in-objective-c.html" target="_blank" rel="noopener">《What is a meta-class in Objective-C?》</a></li>
</ul>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>
<div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#概念"><span class="toc-number">1.</span> <span class="toc-text">概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#实例对象（objc-object）"><span class="toc-number">1.1.</span> <span class="toc-text">实例对象（objc_object）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#类对象（objc-class）"><span class="toc-number">1.2.</span> <span class="toc-text">类对象（objc_class）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#元类"><span class="toc-number">1.3.</span> <span class="toc-text">元类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#理解好对象、类和元类的关系（为什么需要元类）"><span class="toc-number">1.3.1.</span> <span class="toc-text">理解好对象、类和元类的关系（为什么需要元类）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引申思考：究竟什么样的数据结构才算对象？"><span class="toc-number">1.3.2.</span> <span class="toc-text">引申思考：究竟什么样的数据结构才算对象？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引申思考：类对象是一个对象，那么元类是对象吗？"><span class="toc-number">1.3.3.</span> <span class="toc-text">引申思考：类对象是一个对象，那么元类是对象吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引申思考：objc-object-对应对象，objc-class-对应类对象，那是不是会有-objc-meta-class-对应元类"><span class="toc-number">1.3.4.</span> <span class="toc-text">引申思考：objc_object 对应对象，objc_class 对应类对象，那是不是会有 objc_meta_class 对应元类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引申思考：为什么所有元类的-isa-指针直接指向了根元类？"><span class="toc-number">1.3.5.</span> <span class="toc-text">引申思考：为什么所有元类的 isa 指针直接指向了根元类？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引申思考：为什么-NSObject-元类的父类是-NSObject-类对象？"><span class="toc-number">1.3.6.</span> <span class="toc-text">引申思考：为什么 NSObject 元类的父类是 NSObject 类对象？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Method（objc-method）"><span class="toc-number">1.4.</span> <span class="toc-text">Method（objc_method）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SEL（objc-selector）"><span class="toc-number">1.5.</span> <span class="toc-text">SEL（objc_selector）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引申思考：关于重载"><span class="toc-number">1.5.1.</span> <span class="toc-text">引申思考：关于重载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引申思考：关于重写"><span class="toc-number">1.5.2.</span> <span class="toc-text">引申思考：关于重写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方法实现（IMP）"><span class="toc-number">1.6.</span> <span class="toc-text">方法实现（IMP）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#类缓存（objc-cache）"><span class="toc-number">1.7.</span> <span class="toc-text">类缓存（objc_cache）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分类（objc-category）"><span class="toc-number">1.8.</span> <span class="toc-text">分类（objc_category）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引申思考：如何在分类中添加属性"><span class="toc-number">1.8.1.</span> <span class="toc-text">引申思考：如何在分类中添加属性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#消息发送（objc-msgSend）"><span class="toc-number">2.</span> <span class="toc-text">消息发送（objc_msgSend）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#消息转发（-objc-msgforward）"><span class="toc-number">3.</span> <span class="toc-text">消息转发（_objc_msgforward）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#动态方法解析"><span class="toc-number">3.1.</span> <span class="toc-text">动态方法解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#快速转发（替换消息接收者）"><span class="toc-number">3.2.</span> <span class="toc-text">快速转发（替换消息接收者）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#完整消息转发"><span class="toc-number">3.3.</span> <span class="toc-text">完整消息转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#引申思考：消息转发为什么要三个阶段呢？"><span class="toc-number">3.4.</span> <span class="toc-text">引申思考：消息转发为什么要三个阶段呢？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Runtime-应用"><span class="toc-number">4.</span> <span class="toc-text">Runtime 应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Swizzle-Method"><span class="toc-number">4.1.</span> <span class="toc-text">Swizzle Method</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义-KVO-实现"><span class="toc-number">4.2.</span> <span class="toc-text">自定义 KVO 实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#给分类添加属性"><span class="toc-number">4.3.</span> <span class="toc-text">给分类添加属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#打印类的所有属性值"><span class="toc-number">4.4.</span> <span class="toc-text">打印类的所有属性值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现-NSCoding-的自动归档和自动解档"><span class="toc-number">4.5.</span> <span class="toc-text">实现 NSCoding 的自动归档和自动解档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现字典和模型的自动转换（MJExtension）"><span class="toc-number">4.6.</span> <span class="toc-text">实现字典和模型的自动转换（MJExtension）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#热更新（JSPatch）"><span class="toc-number">4.7.</span> <span class="toc-text">热更新（JSPatch）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考文章"><span class="toc-number">5.</span> <span class="toc-text">参考文章</span></a></li></ol>
</div></section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            TK &copy; 2020 
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" /></a>
            <br> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme - <a href="https://github.com/zthxxx/hexo-theme-Wikitten">wikitten</a>
            
        </div>
    </div>
</footer>

        

    
        <script src="/wiki/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/wiki/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/wiki/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/wiki/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/wiki/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/wiki/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/wiki/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/wiki/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/wiki/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/wiki/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->
<script src="/wiki/js/main.js"></script>

    </div>
</body>
</html>